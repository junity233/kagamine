<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <title>Kagamine</title>
    <meta name="keywords" content="镜音双子,镜音连,镜音连,Kagamine,Rin,Len">
    <meta name="description" content="如果天使有声音，那么一定是镜音的天籁！">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/css/mdui.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/js/mdui.min.js"></script>
    <script src="/js/jquery.min.js"></script>
</head>

<body class="mdui-bottom-nav-fixed mdui-theme-primary-teal mdui-theme-accent-pink mdui-theme-layout-auto mdui-loaded">
    <div id="page-index" class="mdui-container" style="max-width: 800px;">
        <h1 class="doc-title mdui-text-color-theme">Kagamine</h1>

        <div class="doc-chapter">
            <div class="mdui-typo">
                <p>在这里，你可以以瀑布流的形式查看图片</p>
            </div>
        </div><br>
        <div class="mdui-row-xs-2 mdui-row-gapless">
            <div class="mdui-col" id="imageBoxCol-0"></div>
            <div class="mdui-col" id="imageBoxCol-1">
                <div id="imgBoxId-main" class="mdui-card">
                    <div class="mdui-card-content">
                        直接显示图片：
                        <label class="mdui-switch">
                            <input id="showImageDirect" type="checkbox" />
                            <i class="mdui-switch-icon"></i>
                        </label>
                        <br>
                        显示加载进度条：
                        <label class="mdui-switch">
                            <input id="showLoadingStatus" type="checkbox" checked />
                            <i class="mdui-switch-icon"></i>
                        </label>
                    </div>
                </div>

            </div>
        </div><br>
        <center><button onclick="loadMore()"
                class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent">加载更多~</button></center>
    </div>
    <div style="display: none;">
        <div id="imageBoxTemplate">
            <div id="imgBoxId-main" style="display: none;" class="mdui-card">
                <div class="mdui-card-media">
                    <img onclick="window.open(this.src)" id='imgBoxId-imageSrc' src="" />
                </div>
                <div id='imgBoxId-loadingBox'>
                    <div id='imgBoxId-loadingBoxHeight' class="mdui-card-content">

                        <h2>LOADING</h2>
                        <br>
                        <div class="mdui-progress">
                            <div id='imgBoxId-loadingStatus' class="mdui-progress-determinate" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>
<script>

    window.imgListURL = "https://static.llilii.cn/json/img_list.json"
    window.imgBaseURL = "https://img.llilii.cn/kagamine/"
    if(getCookie("showLoadingStatus")==""){
        window.showLoadingStatus = true
    } else {
        window.showLoadingStatus = (getCookie("showLoadingStatus")=="true")
        $("#showLoadingStatus").attr("checked", showLoadingStatus);
    }
    if(getCookie("showImageDirect")==""){
        window.showImageDirect = true
    } else {
        window.showImageDirect = (getCookie("showImageDirect")=="true")
        $("#showImageDirect").attr("checked", showImageDirect);
    }
    window.showImageDirect = false
    //window.imgListURL = "https://static.llilii.cn/json/keqingImagesList.json"
    //window.imgBaseURL = "https://img.llilii.cn/genshin-impact/keqing/"

    $.get(imgListURL, function (rdata) {
        window.imgList = rdata
        loadMore()
    });

    function loadMore() {
        for (i = 0; i < 10; i++) {
            imgBoxCreate(i % 2)
        }
    }

    $("#showLoadingStatus").click(function () {
        setCookie("showLoadingStatus", $("#showLoadingStatus").prop("checked"), 30)
        showLoadingStatus = $("#showLoadingStatus").prop("checked")
    })

    $("#showImageDirect").click(function () {
        setCookie("showImageDirect", $("#showImageDirect").prop("checked"), 30)
        showImageDirect = $("#showImageDirect").prop("checked")
        $("#showLoadingStatus").attr("disabled", showImageDirect)

    })


    function randomNumBoth(min, max) {
        var range = max - min;
        var rand = Math.random();
        var num = min + Math.round(rand * range);
        return num;
    }

    function isMobile() {
        var userAgentInfo = navigator.userAgent;
        var mobileAgents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
        var mobileFlag = false;
        for (var v = 0; v < mobileAgents.length; v++) {
            if (userAgentInfo.indexOf(mobileAgents[v]) > 0) {
                mobileFlag = true;
                break;
            }
        }
        var screenWidth = window.screen.width;
        var screenHeight = window.screen.height;
        if (screenWidth < 500 && screenHeight < 800) {
            mobileFlag = true;
        }
        return mobileFlag;
    }

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) return c.substring(name.length, c.length);
        }
        return "";
    }

    function loadImage(imgURL, imgBoxId, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', imgURL);
        xhr.onprogress = function (event) {
            if (event.lengthComputable) {
                $("#" + imgBoxId.toString() + "-loadingStatus").css("width", parseInt((event.loaded / event.total) * 100).toString() + "%")
            }
        };
        xhr.onreadystatechange = function () {
            switch (xhr.readyState) {
                case 4:
                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                        console.log(imgURL)
                        callback(imgBoxId, imgURL)
                    } else {
                        mdui.snackbar({
                            message: '抱歉，图片加载失败！',
                            position: 'left-top'
                        });
                    }
            }
        };
        xhr.send();
    }

    function imgBoxCreate(colId) {
        imgBoxId = randomNumBoth(100000, 99999999)
        imageBoxTemplate = $("#imageBoxTemplate").html()
        imageBoxTemplate = imageBoxTemplate.replaceAll("imgBoxId", imgBoxId)
        $("#imageBoxCol-" + colId.toString()).append(imageBoxTemplate)
        imgURL = imgBaseURL + imgList['file_name'][randomNumBoth(0, imgList['file_num'])]
        $("#" + imgBoxId.toString() + "-imageSrc").attr("src", imgURL);
        $("#" + imgBoxId.toString() + "-imageSrc").hide()
        if (isMobile()) {
            $("#" + imgBoxId.toString() + "-loadingBox").css("height", randomNumBoth(100, 200).toString() + "px")
        } else {
            $("#" + imgBoxId.toString() + "-loadingBox").css("height", randomNumBoth(400, 600).toString() + "px")
        }
        if (showImageDirect) {
            $("#" + imgBoxId.toString() + "-imageSrc").show()
            $("#" + imgBoxId.toString() + "-loadingBox").hide()
            $("#" + imgBoxId.toString() + "-main").show(200)
        } else {
            if (showLoadingStatus) {
                $("#" + imgBoxId.toString() + "-main").show(200)
            }
            loadImage(imgURL, imgBoxId, function (imgBoxId, imgURL) {
                if (!showLoadingStatus) {
                    $("#" + imgBoxId.toString() + "-main").show(200)
                }
                $("#" + imgBoxId.toString() + "-imageSrc").show()
                $("#" + imgBoxId.toString() + "-loadingBox").hide()
            })
        }
    }
</script>